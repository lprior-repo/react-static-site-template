name: ðŸš€ Continuous Integration & Deployment

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  TERRAFORM_VERSION: '1.13.0'
  TFLINT_VERSION: 'v0.54.0'

jobs:
  # ðŸ” Code Quality & Security
  quality-gate:
    name: ðŸ›¡ï¸ Quality Gate
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.quality-check.outputs.passed }}
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --production=false

      - name: ðŸ” Lint Code
        run: |
          npm run lint
          npm run format:check

      - name: ðŸ”’ Security Audit
        run: |
          npm audit --audit-level=moderate
          if command -v npm run security:check &> /dev/null; then
            npm run security:check
          fi

      - name: ðŸ—ï¸ Type Check
        run: npm run type-check

      - name: ðŸ§ª Unit Tests
        run: npm run test:coverage

      - name: ðŸ“Š Upload Coverage
        uses: codecov/codecov-action@e28ff129e5465c2c0dcc6f003fc735cb6ae0c673 # v4.5.0
        with:
          directory: ./coverage
          flags: react-unit
          name: react-unit-tests

      - name: âœ… Quality Check Passed
        id: quality-check
        run: echo "passed=true" >> $GITHUB_OUTPUT

  # ðŸ—ï¸ Build & Package
  build:
    name: ðŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: quality-gate
    if: needs.quality-gate.outputs.should-deploy == 'true'
    outputs:
      build-version: ${{ steps.version.outputs.version }}
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --production=false

      - name: ðŸ—ï¸ Build Application
        run: npm run build

      - name: ðŸ“‹ Generate Version
        id: version
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            VERSION="v$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          else
            VERSION="${{ github.ref_name }}-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Build version: $VERSION"

      - name: ðŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: react-build-${{ steps.version.outputs.version }}
          path: |
            dist/
          retention-days: 30

      - name: ðŸ“Š Bundle Size Analysis
        run: |
          echo "## ðŸ“¦ Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "| Asset Type | Size | Compressed |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|------|------------|" >> $GITHUB_STEP_SUMMARY

          # Analyze JS bundles
          find dist/assets -name "*.js" -type f | while read file; do
            name=$(basename "$file")
            size=$(stat -c%s "$file" | numfmt --to=iec)
            gzipped=$(gzip -c "$file" | wc -c | numfmt --to=iec)
            echo "| $name | $size | $gzipped |" >> $GITHUB_STEP_SUMMARY
          done

          # Analyze CSS bundles
          find dist/assets -name "*.css" -type f | while read file; do
            name=$(basename "$file")
            size=$(stat -c%s "$file" | numfmt --to=iec)
            gzipped=$(gzip -c "$file" | wc -c | numfmt --to=iec)
            echo "| $name | $size | $gzipped |" >> $GITHUB_STEP_SUMMARY
          done

  # ðŸ—ï¸ Infrastructure Validation
  infrastructure:
    name: ðŸ—ï¸ Infrastructure Validation
    runs-on: ubuntu-latest
    needs: quality-gate
    if: needs.quality-gate.outputs.should-deploy == 'true'
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: ðŸ”§ Terraform Init
        working-directory: terraform
        run: terraform init -backend=false

      - name: âœ… Terraform Validate
        working-directory: terraform
        run: terraform validate

      - name: ðŸŽ¨ Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive

      - name: ðŸ” Setup TFLint
        uses: terraform-linters/setup-tflint@19a52fbac37dacb22a09518e4ef6ee234f2d4987 # v4.0.0
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: ðŸ” Run TFLint
        working-directory: terraform
        run: |
          echo "Creating .tflint.hcl if it doesn't exist..."
          if [ ! -f .tflint.hcl ] && [ ! -f ../.tflint.hcl ]; then
            cat > .tflint.hcl << 'EOF'
          plugin "aws" {
              enabled = true
              version = "0.35.0"
              source  = "github.com/terraform-linters/tflint-ruleset-aws"
          }

          rule "terraform_required_version" {
            enabled = true
          }

          rule "terraform_required_providers" {
            enabled = true
          }

          rule "terraform_naming_convention" {
            enabled = true
          }

          rule "terraform_standard_module_structure" {
            enabled = true
          }
          EOF
          fi

          tflint --init
          if [ -f ../.tflint.hcl ]; then
            tflint --recursive --config=../.tflint.hcl
          else
            tflint --recursive
          fi

  # ðŸ§ª E2E Tests
  e2e-tests:
    name: ðŸ§ª E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'pull_request'
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: react-build-${{ needs.build.outputs.build-version }}
          path: dist

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ§ª Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: ðŸ§ª Run E2E Tests
        run: |
          npm run preview &
          sleep 5
          npx playwright test

      - name: ðŸ“Š Upload E2E Test Results
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        if: always()
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/

  # ðŸ“ˆ Performance & Accessibility
  lighthouse:
    name: ðŸ“ˆ Lighthouse Audit
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'pull_request'
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: react-build-${{ needs.build.outputs.build-version }}
          path: dist

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸš€ Start Preview Server
        run: |
          npm run preview &
          sleep 5

      - name: ðŸ“ˆ Run Lighthouse
        uses: treosh/lighthouse-ci-action@03becbfc543944dd6e7534f7ff768abb8a296826 # v12.1.0
        with:
          urls: |
            http://localhost:4173
            http://localhost:4173/about
            http://localhost:4173/contact
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ðŸš€ Deployment Planning
  deployment-plan:
    name: ðŸš€ Deployment Plan
    runs-on: ubuntu-latest
    needs: [build, infrastructure]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
    steps:
      - name: ðŸŽ¯ Determine Environment
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

      - name: âœ… Deployment Check
        id: deploy-check
        run: echo "should-deploy=true" >> $GITHUB_OUTPUT

  # ðŸš€ Deploy to AWS
  deploy:
    name: ðŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: [deployment-plan, build]
    if: needs.deployment-plan.outputs.should-deploy == 'true'
    environment:
      name: ${{ needs.deployment-plan.outputs.environment }}
      url: ${{ steps.deploy.outputs.website_url }}
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: ðŸ”§ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: ðŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: react-build-${{ needs.build.outputs.build-version }}
          path: dist

      - name: ðŸ—ï¸ Deploy Infrastructure
        id: terraform
        working-directory: terraform
        run: |
          terraform init
          terraform plan -var="environment=${{ needs.deployment-plan.outputs.environment }}"
          terraform apply -var="environment=${{ needs.deployment-plan.outputs.environment }}" -auto-approve
          echo "bucket_name=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
          echo "distribution_id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT
          echo "website_url=$(terraform output -raw website_url)" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Deploy Assets to S3
        run: |
          # Deploy assets with long cache headers
          aws s3 sync dist/ s3://${{ steps.terraform.outputs.bucket_name }} \
            --delete \
            --cache-control "max-age=31536000" \
            --exclude "*.html" \
            --exclude "*.xml" \
            --exclude "*.txt"

          # Deploy HTML files with no cache
          aws s3 sync dist/ s3://${{ steps.terraform.outputs.bucket_name }} \
            --delete \
            --cache-control "max-age=0, no-cache, no-store, must-revalidate" \
            --include "*.html" \
            --include "*.xml" \
            --include "*.txt"

      - name: ðŸ”„ Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.terraform.outputs.distribution_id }} \
            --paths "/*"

      - name: âœ… Deployment Summary
        id: deploy
        run: |
          echo "website_url=${{ steps.terraform.outputs.website_url }}" >> $GITHUB_OUTPUT
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Environment: ${{ needs.deployment-plan.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Website URL: ${{ steps.terraform.outputs.website_url }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ S3 Bucket: ${{ steps.terraform.outputs.bucket_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ CloudFront Distribution: ${{ steps.terraform.outputs.distribution_id }}" >> $GITHUB_STEP_SUMMARY